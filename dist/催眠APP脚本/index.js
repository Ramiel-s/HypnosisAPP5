var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=_;var n=t.n(e);const a='角色',r='系统.当前日期',i='系统.当前时间',s='系统.主角可疑度',o=['系统._MC能量','系统.MC能量'],u=['系统._MC能量上限','系统.MC能量上限'],l=[31,28,31,30,31,30,31,31,30,31,30,31],c=['一','二','三','四','五','六','日'];function f(t,e=null){const n='number'==typeof t?t:Number(t);return Number.isFinite(n)?n:e}function d(t,e,n){return Math.min(n,Math.max(e,t))}function y(t){if('string'!=typeof t)return null;const e=/^(\d{1,2})\s*:\s*(\d{1,2})(?:\s*:\s*(\d{1,2}))?$/.exec(t.trim());if(!e)return null;const n=Number(e[1]),a=Number(e[2]);return Number.isFinite(n)&&Number.isFinite(a)?n<0||n>23||a<0||a>59?null:60*n+a:null}function m(t){if('string'!=typeof t)return null;const e=t.trim(),n=/(\d{1,2})\s*月\s*(\d{1,2})\s*日/.exec(e);if(!n)return null;const a=Number(n[1]),r=Number(n[2]);if(!Number.isFinite(a)||!Number.isFinite(r))return null;const i=/(星期|周)\s*([一二三四五六日天])/.exec(e),s=i?i[2]:null,o='天'===s?'日':s,u=o?c.indexOf(o):-1;return{month:d(a,1,12),day:d(r,1,l[d(a,1,12)-1]),weekdayIndex:u>=0?u:null}}function g(t){const e=d(t.month,1,12)-1,n=d(t.day,1,l[e])-1;return l.slice(0,e).reduce((t,e)=>t+e,0)+n}function M(t){if(null===t.weekdayIndex)return`${t.month}月${t.day}日`;const e=c[d(t.weekdayIndex,0,c.length-1)];return`${t.month}月${t.day}日 星期${e}`}async function h(t,e,a,r='催眠APP脚本：每日结算'){const i=n().get(t.stat_data,e);if(n().isEqual(i,a))return!1;const s=Mvu.setMvuVariable;if('function'==typeof s){const i=await s(t,e,a,{reason:r});return i&&n().set(t.stat_data,e,a),i}return n().set(t.stat_data,e,a),!0}function x(t,e){for(const a of e)if(n().has(t,a))return a;return e[0]}function b(t,e,n,a){const r=m(t),i=m(e),s=y(n),o=y(a),u=null!==s&&null!==o&&o<s;if(!r||!i){const n='string'==typeof t&&'string'==typeof e&&t===e&&u;return{dayDelta:n?1:0,isDateMissingUpdate:n}}const f=g(r);let h=g(i)-f;h<0&&(h+=365);if(!(0===h&&u))return{dayDelta:Math.max(0,Math.floor(h)),isDateMissingUpdate:!1};return{dayDelta:1,isDateMissingUpdate:!0,nextDateText:M(function(t,e){let n=d(t.month,1,12),a=d(t.day,1,l[n-1]),r=t.weekdayIndex,i=Math.max(0,Math.floor(e));for(;i>0;)a+=1,a>l[n-1]&&(a=1,n+=1,n>12&&(n=1)),null!==r&&(r=(r+1)%c.length),i-=1;return{month:n,day:a,weekdayIndex:r}}(i,1))}}$(()=>{(async()=>{try{await waitGlobalInitialized('Mvu')}catch(t){return void console.warn('[催眠APP脚本] Mvu 未就绪，脚本不生效',t)}let t=!1;eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,async(e,l)=>{if(t)t=!1;else try{const c=await async function(t,e){const l=t.stat_data??{},c=e?.stat_data??{},y=n().get(c,r),m=n().get(l,r),g=n().get(c,i),M=n().get(l,i),{dayDelta:p,isDateMissingUpdate:w,nextDateText:v}=b(y,m,g,M);if(p<=0&&!w)return!1;let D=!1;w&&'string'==typeof v&&await h(t,r,v)&&(D=!0);const N=x(l,o),P=x(l,u),I=f(n().get(l,N),0)??0,O=f(n().get(l,P),null);if(null!==O){const e=Math.max(0,O),a=d(I+.5*e*p,0,e);await h(t,N,a)&&(D=!0);for(const r of[...o,...u]){if(!n().has(l,r))continue;if(r===N||r===P)continue;const i=r.includes('能量上限')?e:a;await h(t,r,i)&&(D=!0)}}const A=f(n().get(l,s),null),j=n().get(l,a);let k=0;if(n().isPlainObject(j))for(const[e,r]of Object.entries(j)){if(!e)continue;if(!n().isPlainObject(r))continue;const i=`${a}.${e}.警戒度`,s=f(n().get(l,i),null);if(null===s)continue;for(let t=0;t<p;t+=1){const e=Math.max(0,s-10*t);k+=Math.floor(e/5)}const o=Math.max(0,s-10*p);await h(t,i,o)&&(D=!0)}if(null!==A){const e=Math.max(0,A-10*p+k);await h(t,s,e)&&(D=!0)}return D}(e,l);if(!c)return;t=!0,await Mvu.replaceMvuData(e,function(){try{return{type:'message',message_id:getCurrentMessageId()}}catch{return{type:'message',message_id:'latest'}}}())}catch(e){console.error('[催眠APP脚本] 每日结算失败',e),t=!1}})})()});
//# sourceMappingURL=index.js.map