# 催眠APP前端（HypnoOS）协作说明

本目录是一个运行于酒馆助手（Tavern Helper）iframe 环境中的前端界面项目：使用 React + TailwindCSS（通过仓库根目录的 Webpack 打包），最终产物输出到仓库根目录 `dist/催眠APP前端/index.html`，供 SillyTavern 内加载使用。

> 适用范围：本文档只覆盖 `src/催眠APP前端` 这棵目录树的协作约定与程序结构。

## 1. 目录结构与关键文件

- `src/催眠APP前端/index.tsx`：入口；在 iframe **加载时机**用 `$(() => ...)` 挂载 React，并在 `pagehide` 卸载。
- `src/催眠APP前端/App.tsx`：App Shell + “桌面/主屏” + 简易路由（`AppMode`）。
- `src/催眠APP前端/types.ts`：核心领域类型（`UserResources` / `HypnosisFeature` / `Achievement` / `Quest` 等）。
- `src/催眠APP前端/services/dataService.ts`：数据源与持久化（读写酒馆变量、特性配置、成就/任务、订阅与时钟）。
- `src/催眠APP前端/services/access.ts`：权限/订阅/解锁判定的纯逻辑（供 `DataService` 与组件复用）。
- `src/催眠APP前端/services/mvuBridge.ts`：与 MVU 变量框架桥接（读写 `Mvu` 数据、同步系统与持久化 store）。
- `src/催眠APP前端/components/HypnosisApp.tsx`：核心“催眠”应用（功能选择、消耗结算、发送消息）。
- `src/催眠APP前端/components/CommonApps.tsx`：通用应用集合（身体检测、日历、帮助等）。
- `src/催眠APP前端/components/AchievementApp.tsx`：成就中心（领取奖励、WIP 任务页）。
- `src/催眠APP前端/index.css`：Tailwind 入口与少量全局样式。
- `src/催眠APP前端/metadata.json`：界面元信息（名称/描述/权限）。

## 2. 构建与运行（以仓库根目录为准）

该项目的**实际打包入口**由仓库根目录 `webpack.config.ts` 扫描 `src/**/index.{ts,tsx,js,jsx}` 自动发现，因此：

- 开发/热更新：在仓库根目录执行 `pnpm watch`
  - 会构建到根目录 `dist/…`
  - 也会触发 `tavern_sync` 的 watch 流程（见 `webpack.config.ts` 的 `watch_tavern_sync`）
- 一次性构建：在仓库根目录执行 `pnpm build`（生产模式）或 `pnpm build:dev`（开发模式）

注意：本目录内的 `package.json` / `vite.config.ts` / `README.md` 更像“独立 Vite 项目遗留”，与当前仓库主构建链路并不一致；协作时请优先以仓库根目录的 Webpack/PNPM 工作为准。

为避免误用：

- `src/催眠APP前端/package.json` 的 `npm run dev/build/preview` 已改为直接报错提示；
- `src/催眠APP前端/vite.config.ts` 仅保留用于追溯来源，不参与最终打包；
- 最终产物请以仓库根目录 `dist/催眠APP前端/index.html` 为准（不要使用/提交本目录下的临时构建产物）。

## 3. 运行环境假设（必须在酒馆/助手环境中成立）

代码默认存在以下全局能力（无需 import）：

- jQuery：`$`（用于“加载时机”与事件绑定）
- 酒馆助手变量接口：`getVariables`、`updateVariablesWith` 等
- 事件/初始化工具：`waitGlobalInitialized`、`eventOn`
- MVU 框架：`Mvu`
- 发送消息与触发命令：`createChatMessages`、`triggerSlash`

因此在纯浏览器直接打开 `dist/催眠APP前端/index.html` 时，可能因为缺少 `$`/酒馆接口而无法正常运行；这是预期行为。

## 4. 数据与持久化：变量契约（重要）

### 4.1 用户资源（`UserResources`）

`services/dataService.ts` 会把“用户资源”映射到聊天级变量 `系统` 下的字段（并用 zod 做默认值与纠错）：

- `系统._MC能量` / `系统._MC能量上限`
- `系统.当前MC点`
- `系统._累计消耗MC点`
- `系统.持有零花钱`
- `系统.主角可疑度`

### 4.2 本项目私有持久化 store（`系统._hypnoos`）

项目把自身运行状态放在 `系统._hypnoos`（`PersistedStore`）中，主要包括：

- `debugEnabled`：调试开关
- `sessionEndVirtualMinutes`：当前催眠“虚拟时间”结束点（用于跨刷新恢复倒计时/状态）
- `sessionEndAtMs`：当前催眠“现实时间”结束点（当无法读取虚拟时间时作为回退；也用于跨刷新恢复倒计时）
- `subscription`：订阅 tier/到期时间/自动续费
- `features`：各功能的开关与备注（`userNote`）
- `achievements` / `quests`：成就领取状态与任务状态

所有对 store 的写入集中通过 `updateStoreWith(...)` 完成，并在写入后调用 `MvuBridge.syncPersistedStore(...)` 做 MVU 同步。

## 5. 模块职责与数据流（协作时的默认做法）

### 5.1 UI 组件不直接操作底层变量

建议：组件层只调用 `DataService`，不直接 `getVariables/updateVariablesWith`，避免出现“多个组件各写一套变量逻辑”的分叉。

例外：`CommonApps.tsx` 内有部分 MVU 事件订阅（`Mvu.events.*`），属于“界面刷新触发器”。

### 5.2 “发送到聊天”的统一出口

`HypnosisApp.tsx` 会用 `buildHypnosisSendMessage(...)` 生成 `<催眠发送>...</催眠发送>` 文本，并在存在全局 `createChatMessages/triggerSlash` 时发送到聊天并触发 `/trigger`。

协作约定：如需新增“发送协议”，优先在 `src/催眠APP前端/prompts/*` 做纯函数构造，避免在组件里拼字符串。

## 6. 常见改动点

### 6.1 新增/修改“催眠功能”（Feature）

- 配置入口：`src/催眠APP前端/services/dataService.ts` 的 `FEATURES`
- UI 展示：`src/催眠APP前端/components/HypnosisApp.tsx` 会按 `tier` 分组渲染，并按 `costType/costValue/costCurrency` 计算消耗
- 持久化：通过 `DataService.updateFeature(...)` 写入 `系统._hypnoos.features`
- “重置时是否保留”：由 `PERSISTENT_FEATURE_IDS` 决定（当前包含 `vip1_stats`）

### 6.2 新增一个“桌面应用”

- 在 `src/催眠APP前端/types.ts` 的 `AppMode` 增加枚举值
- 在 `src/催眠APP前端/App.tsx`：
  - HomeScreen 增加 app 图标入口
  - `renderCurrentApp()` 增加路由分发

补充：也允许做“快捷动作应用”（不切换 `AppMode`，只执行一次操作）。例如主页的 `MC匿名版` 图标会在当前楼层消息末尾追加 `<匿名版></匿名版>`（通过 `setChatMessages(..., { refresh: 'none' })`），用于给酒馆侧流程提供一个可被读取的标记。

## 7. 代码风格与协作约定（建议）

- 以 TypeScript 类型为准：新增跨模块数据尽量落到 `types.ts` 并在 `DataService` 层验证/归一化。
- UI 使用 Tailwind 原子类为主：避免“散落的全局 CSS”。
- 日志前缀统一：当前多用 `[HypnoOS] ...`。
- 不要手改根目录 `dist/`：它由打包流程生成（模板仓库也默认将 `dist/` 提交到仓库）。
